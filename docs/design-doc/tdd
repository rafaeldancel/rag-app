# Technical Design Document (TDD): **Logos**

**Version:** 2.0 (Integrated Bible RAG)

**Date:** February 20, 2026

**Status:** Implementation Ready

---

## 1. System Architecture

**Logos** is a high-performance mentorship platform built on a **Monorepo** (Turborepo) architecture. It leverages a **Thin-Client RAG** model, where the React frontend remains lightweight, and complex theological reasoning is handled by **tRPC** procedures in Firebase Cloud Functions.

### ðŸ—ï¸ Architectural Overview

Code snippet

#

`graph TD
User((User)) --> Web[React Frontend /apps/web]
Web --> tRPC[tRPC Client]
tRPC --> Server[Cloud Functions /apps/functions]

    subgraph "Reasoning Engine"
        Server --> RAG[RAG Pipeline]
        RAG --> Gemini[Vertex AI: Gemini 3 Flash]
    end

    subgraph "Persistence & Memory"
        Server --> Firestore[(Firestore: User Data)]
        RAG --> BibleDB[Firestore Vector Index: Whole Bible]
        RAG --> CourtDB[Vertex AI Search: Courtroom Library]
        RAG --> Cache[Firestore: Semantic Cache]
    end

    Gemini --> User`

---

## 2. Component Specifications

### 2.1 Frontend (`apps/web`)

- **Core:** React 19, TypeScript 5.x.
- **Data Fetching:** **TanStack Query** integrated with the tRPC client for end-to-end type safety.
- **UI/UX:** Shadcn UI (Tailwind CSS v4). Custom **Constellation Map** rendered via SVG or Canvas for non-linear progress tracking.
- **Bible Reader:** Secured proxy connection to the **YouVersion Platform API** for live scripture viewing and translation switching.

### 2.2 Backend (`apps/functions`)

- **API Layer:** **tRPC** implementation via Firebase Cloud Functions (v2).
- **Logic Orchestrator:** Manages the **"Courtroom Logic"**â€”ensuring every prompt is balanced with scripture, theist evidence, and skeptic steel-manning.
- **Environment:** Node.js 22.x (LTS) with GCP Secret Manager for API keys.

### 2.3 Shared Packages (`packages/*`)

- **`@repo/shared`:** Zod schemas for the 3-Axis Audit, Diary Entries, and Note types.
- **`@repo/ui`:** Shared React components (Peter Action Modal, Worldview Sliders).

---

## 3. Data Design: The "Bible-First" RAG

### 3.1 Bible Vectorization (Primary Source)

- **Storage:** The entire Bible (NASB/ESV) is stored in the `bible_verses` Firestore collection.
- **Indexing:** Each verse is an individual document with a pre-calculated vector (`embedding` field).
- **Indexing Logic:** Use **Firestore Vector Search** with `DOT_PRODUCT` distance measure on unit-normalized vectors for maximum efficiency.
- **Schema:**TypeScript
  #
  `{
  verse_id: "GEN_1_1",
  text: "In the beginning...",
  embedding: [0.12, -0.05, ...], // 768-dim (Vertex AI)
  metadata: { book: "Genesis", chapter: 1, verse: 1 }
}`

### 3.2 Personal Context Memory

- **Embeddings:** User diary entries and notes are vectorized upon save via a Cloud Function.
- **Retrieval:** When the user interacts with Peter, the system performs a **Cosine Similarity** search against the user's specific diary collection to personalize the mentorship.

---

## 4. Efficiency & Performance Guardrails

### 4.1 Vertex Context Caching

- **Implementation:** Peter's "System Instructions" and "Logos Logic Bridge" (~3k tokens) are **Cached** via Vertex AI.
- **Impact:** Reduces input token costs by **~90%** for active conversation sessions.

### 4.2 Semantic Cache

- **Logic:** A Firestore collection `semantic_cache` stores `hash(query)` $\rightarrow$ `response`.
- **Benefit:** Frequent theological questions (e.g., "Why does God allow suffering?") are served instantly at $0$ LLM cost.

### 4.3 Hybrid Multi-Model Routing

- **Tier 0/1 (Fact/History):** Handled by **Gemini 3 Flash** for low-latency, high-accuracy retrieval.
- **Tier 2 (Deep Philosophy):** Automatically escalated to **Gemini 1.5 Pro** if the RAG context exceeds 32k tokens or high-density reasoning is required.

---

## 5. Security & Deployment (WIF)

- **Auth:** Firebase Authentication (Google/Email).
- **Access Control:** Firestore Security Rules ensure that personal diary vectors are only searchable by the owner.
- **CI/CD:** GitHub Actions using **Workload Identity Federation (WIF)**.
  - `deploy-dev`: Triggered on push to `dev`.
  - `deploy-main`: Manual production release after staging validation.
