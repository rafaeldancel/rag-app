# Technical Design Document (TDD): **Logos**

**Version:** 1.0

**Date:** February 20, 2026

**Tech Stack:** React, TypeScript, Turborepo, Firebase, tRPC, Vertex AI.

---

## 1. System Architecture

Logos follows a **Monorepo** architecture powered by **Turborepo** to maintain strict type-safety between the frontend, backend, and shared logic. The system is designed as a "Thin-Client" RAG application where the heavy lifting (reasoning and retrieval) is offloaded to the cloud while keeping the UI snappy.

### High-Level Diagram

```mermaid
graph TD
    User((User)) --> Web[React Frontend /apps/web]
    Web --> tRPC[tRPC Client /trpc]
    tRPC --> Server[Cloud Functions /apps/functions]

    subgraph "Logic & Reasoning"
        Server --> RAG[RAG Pipeline]
        RAG --> Gemini[Vertex AI: Gemini 3 Flash]
    end

    subgraph "Persistence & Memory"
        Server --> Firestore[(Firestore: User Data)]
        RAG --> KnowledgeDB[Vertex AI Search: Courtroom Library]
        RAG --> Cache[Firestore: Semantic Cache]
    end

    Gemini --> User

```

---

## 2. Component Specifications

### 2.1 Frontend (`apps/web`)

- **Framework:** React 19 + Vite 7.
- **Styling:** Tailwind CSS v4 + Shadcn UI components.
- **State Management:** \* **Server State:** TanStack Query (via tRPC) for data fetching and mutations.
- **Local State:** Zustand for UI-specific states (e.g., chat visibility, reader preferences).

- **Bible Reader:** Secured proxy connection to the **YouVersion Platform API** to fetch verse text and cross-references.

### 2.2 Backend (`apps/functions`)

- **API Layer:** **tRPC** implementation via Firebase Cloud Functions.
- **Language:** TypeScript (Strict mode).
- **RAG Orchestration:**
- **Embeddings:** `text-multilingual-embedding-002` (Vertex AI).
- **Context Management:** Custom logic to prioritize recent chat history and relevant diary entries before final prompt assembly.

### 2.3 Shared Packages (`packages/*`)

- **`@repo/shared`:** Centralized Zod schemas (User profile, 3-Axis results, Diary entry types).
- **`@repo/ui`:** Shared component library ensuring UI consistency between the Web and future mobile versions.
- **`@repo/typescript-config`:** Shared strict compiler configurations.

---

## 3. Data Design & Memory

### 3.1 Firestore Collections

| Collection       | Field Snapshot                                             | Purpose                                  |
| ---------------- | ---------------------------------------------------------- | ---------------------------------------- |
| `users`          | `{ worldview_axes: { e: number, o: number, m: number } }`  | Stores the Audit baseline.               |
| `diary`          | `{ content: string, vector_id: string, insight: string }`  | Individual reflections and AI responses. |
| `notes`          | `{ verse_id: string, text: string, user_id: string }`      | User annotations on Scripture.           |
| `semantic_cache` | `{ query_hash: string, response: string, ttl: timestamp }` | Minimizes redundant LLM calls.           |

### 3.2 Vector Search Logic

The system uses **Vertex AI Search** for the "Courtroom Library" and **Firestore Vector Search** for personal memory.

- **Clash Logic:** Every retrieval for Tier 0/1 must return (Theist) and (Skeptic) to feed the prompt.
- **Personal Memory:** Peter performs a Cosine Similarity search against the user's `diary` and `notes` to personalize guidance.

---

## 4. Optimization & Security

### 4.1 Cost Efficiency Logic

- **Vertex Context Caching:** Peter's "System Instructions" and "Logic Bridge" rules are cached to reduce input token billing by **~90%**.
- **Tiered Reasoning:** \* **Default:** Gemini 3 Flash.
- **Complex:** Gemini 1.5 Pro (Only triggered if Tier 2 philosophical density is detected).

### 4.2 Security & Authentication

- **Firebase App Check:** Prevents unauthorized replay attacks on the tRPC endpoints.
- **Firestore Rules:** Enforce `request.auth.uid == resource.data.userId` for all diary and note collections.
- **API Security:** All YouVersion API keys and Vertex credentials are stored in **GCP Secret Manager**.

---

## 5. Deployment Pipeline (CI/CD)

- **Infrastructure as Code:** Automated via GitHub Actions.
- **WIF (Workload Identity Federation):** Keyless auth to Google Cloud.
- **Pipeline Steps:**

1. `pnpm precheck`: Linting, type-checking, and unit testing (Vitest).
2. `turbo build`: Incremental build of apps and packages.
3. `firebase deploy`: Parallel deployment of Hosting (Web) and Functions (Backend).

---
